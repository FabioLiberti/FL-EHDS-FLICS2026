#!/bin/bash
# ======================================================================
# FL-EHDS pre-commit hook
# ======================================================================
# Legge i checkpoint e aggiorna EXPERIMENT_STATUS.md prima di ogni commit.
# Funziona sia da VS Code GUI che da terminale.
# ======================================================================

REPO_DIR="$(git rev-parse --show-toplevel)"
STATUS_FILE="${REPO_DIR}/EXPERIMENT_STATUS.md"

# Se il file di status non esiste, skip
[[ -f "$STATUS_FILE" ]] || exit 0

# Aggiorna timestamp e status leggendo i checkpoint
python3 << 'PYEOF'
import json, re, os, subprocess
from datetime import datetime
from pathlib import Path

repo = subprocess.check_output(["git", "rev-parse", "--show-toplevel"], text=True).strip()
fw = Path(repo) / "fl-ehds-framework" / "benchmarks"
status_file = Path(repo) / "EXPERIMENT_STATUS.md"

# --- Read checkpoints ---

def read_ckpt(path):
    try:
        with open(path) as f:
            d = json.load(f)
        if "completed" in d and isinstance(d["completed"], dict):
            return len(d["completed"])
    except:
        pass
    return 0

def read_block(block):
    sf = fw / "paper_results_tabular" / "cascade_remaining_status.txt"
    if sf.exists():
        for line in sf.read_text().splitlines():
            if line.startswith(f"{block}="):
                return line.split("=", 1)[1].strip()
    return "UNKNOWN"

epochs_done = read_ckpt(fw / "paper_results_tabular" / "checkpoint_epochs_sweep.json")
topk_done = read_ckpt(fw / "paper_results_tabular" / "checkpoint_topk_ptbxl.json")
cm_done = read_ckpt(fw / "paper_results_delta" / "checkpoint_confusion_chest.json")

b1 = read_block("BLOCK1")
b2 = read_block("BLOCK2")
b3 = read_block("BLOCK3")

def exp_status(block_st, done, total):
    if block_st == "DONE":
        return "DONE"
    elif done > 0:
        return f"IN PROGRESS ({done}/{total})"
    return "PENDING"

es = exp_status(b1, epochs_done, 140)
ts = exp_status(b2, topk_done, 9)
cs = exp_status(b3, cm_done, 6)

# Machine status
if b1 == "DONE" and b2 == "DONE" and b3 == "DONE":
    ms = "Libero (cascade completata)"
elif epochs_done > 0 or topk_done > 0 or cm_done > 0:
    ms = f"In corso: cascade ({epochs_done}+{topk_done}+{cm_done}/155)"
else:
    ms = None  # Don't change

# --- Read file, update line-by-line ---

hostname = os.uname().nodename.split(".")[0]
timestamp = datetime.now().strftime("%Y-%m-%dT%H:%M:%S CET")

lines = status_file.read_text().splitlines()
new_lines = []
changed = False

for line in lines:
    original = line

    # Update timestamp
    if line.startswith("**Last update:**"):
        line = f"**Last update:** {timestamp} ({hostname})"

    # Update MacBook Air M3 machine status (only in Machines table)
    # Match: | MacBook Air M3 | ... | ... |
    elif ms and line.startswith("| MacBook Air M3 |"):
        parts = line.split("|")
        if len(parts) >= 5:
            parts[3] = f" {ms} "
            line = "|".join(parts)

    # Update experiment rows â€” match by exact experiment name at start of row
    # Only updates the LAST column (Status) of 5-column inventory rows
    elif line.startswith("| Epochs Sweep |"):
        parts = line.split("|")
        if len(parts) >= 7:  # 5 data columns + 2 boundary
            parts[5] = f" {es} "
            # Also fix N.exp column if it was corrupted
            parts[4] = " 140 "
            line = "|".join(parts)

    elif line.startswith("| Top-K PTB-XL |"):
        parts = line.split("|")
        if len(parts) >= 7:
            parts[5] = f" {ts} "
            parts[4] = " 9 "
            line = "|".join(parts)

    elif line.startswith("| Confusion Matrix Chest |"):
        parts = line.split("|")
        if len(parts) >= 7:
            parts[5] = f" {cs} "
            parts[4] = " 6 "
            line = "|".join(parts)

    # Update Remaining Gaps rows (match by priority + experiment name prefix)
    elif "Epochs Sweep" in line and line.startswith("| HIGH") or \
         "Epochs Sweep" in line and line.startswith("|"):
        if "Epochs Sweep" in line and ("HIGH" in line or "algorithm collapse" in line):
            parts = line.split("|")
            if len(parts) >= 7:
                parts[5] = f" {es} "
                line = "|".join(parts)

    elif "Top-K PTB-XL" in line and ("HIGH" in line or "comm. efficiency" in line):
        parts = line.split("|")
        if len(parts) >= 7:
            parts[5] = f" {ts} "
            line = "|".join(parts)

    elif "Confusion Matrix Chest" in line and ("MED" in line or "imaging" in line) and \
         not line.startswith("| Confusion Matrix Chest |"):
        parts = line.split("|")
        if len(parts) >= 7:
            parts[5] = f" {cs} "
            line = "|".join(parts)

    if line != original:
        changed = True

    new_lines.append(line)

if changed:
    status_file.write_text("\n".join(new_lines) + "\n")
    print("  [pre-commit] EXPERIMENT_STATUS.md aggiornato")
PYEOF

# Stage il file aggiornato (se modificato)
if ! git diff --quiet "$STATUS_FILE" 2>/dev/null; then
    git add "$STATUS_FILE"
fi

exit 0
